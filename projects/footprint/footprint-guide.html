<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="top" title="Home" href="http://www.mozilla.org/">
<link rel="stylesheet" type="text/css" href="../../css/print.css"  media="print">
<link rel="stylesheet" type="text/css" href="../../css/base/content.css"  media="all">
<link rel="stylesheet" type="text/css" href="../../css/cavendish/content.css" title="Cavendish" media="screen">
<link rel="stylesheet" type="text/css" href="../../css/base/template.css"  media="screen">
<link rel="stylesheet" type="text/css" href="../../css/cavendish/template.css" title="Cavendish" media="screen">
<link rel="icon" href="../../images/mozilla-16.png" type="image/png">

  <title>Demystifying Footprint</title>
                                                                     
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
<script src="../../__utm.js" type="text/javascript"></script>
</head>
<body id="www-mozilla-org" class="deepLevel">
<div id="container">
<p class="important">You are currently viewing a snapshot of www.mozilla.org taken on April 21, 2008. Most of this content is
highly out of date (some pages haven't been updated since the project began in 1998) and exists for historical purposes only.  If
there are any pages on this archive site that you think should be added back to www.mozilla.org, please <a
href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Websites&component=www.mozilla.org">file a bug</a>.</p>
<p class="skipLink"><a href="#mainContent" accesskey="2">Skip to main content</a></p>
<div id="header">
<h1><a href="/" title="Return to home page" accesskey="1">Mozilla</a></h1>
<ul>
<li id="menu_aboutus"><a href="../../about/" title="Getting the most out of your online experience">About</a></li>
<li id="menu_developers"><a href="../../developer/" title="Using Mozilla's products for your own applications">Developers</a></li>
<li id="menu_store"><a href="http://store.mozilla.org/?r=mozorg1" title="Shop for Mozilla products on CD and other merchandise">Store</a></li>
<li id="menu_support"><a href="../../support/" title="Installation, trouble-shooting, and the knowledge base">Support</a></li>
<li id="menu_products"><a href="../../products/" title="All software Mozilla currently offers">Products</a></li>
</ul>
<form id="searchbox_002443141534113389537:ysdmevkkknw" action="http://www.google.com/cse" title="mozilla.org Search">
<div>
<label for="q" title="Search mozilla.org's sites">search mozilla:</label>
<input type="hidden" name="cx" value="002443141534113389537:ysdmevkkknw">
<input type="hidden" name="cof" value="FORID:0">
<input type="text" id="q" name="q" accesskey="s" size="30">
<input type="submit" id="submit" value="Go">
</div>
</form>
</div>
<hr class="hide">
<div id="mBody">
<div id="side">

<ul id="nav">
<li><a title="Roadmap" href="../../roadmap.html"><strong> Roadmap</strong></a></li>
<li><a title="Projects" href="../../projects/"><strong> Projects</strong></a></li>
<li><a title="For developers" href="../../developer/"><strong> Coding</strong></a>
<ul>
<li><a title="Module Owners" href="../../owners.html"> Module Owners</a></li>
<li><a title="Hacking" href="../../hacking/"> Hacking</a></li>
<li><a title="Get the Source" href="http://developer.mozilla.org/en/docs/Download_Mozilla_Source_Code"> Get the Source</a></li>
<li><a title="Building Mozilla" href="http://developer.mozilla.org/en/docs/Build_Documentation"> Build It</a></li>
</ul>
</li>
<li><a title="Testing" href="../../quality/"><strong> Testing</strong></a>
<ul>
<li><a title="Downloads of mozilla.org software releases" href="../../download.html"> Releases</a></li>
<li><a title="Latest mozilla builds for testers" href="../../developer/#builds"> Nightly Builds</a></li>
<li><a title="For testers to report bugs" href="https://bugzilla.mozilla.org/"> Report A Problem</a></li>
</ul>
</li>
<li><a title="Tools for mozilla developers" href="../../tools.html"><strong> Tools</strong></a>
<ul>
<li><a title="Bug tracking system for mozilla testers." href="https://bugzilla.mozilla.org/"> Bugzilla</a></li>
<li><a title="Latest status of mozilla builds" href="http://tinderbox.mozilla.org/showbuilds.cgi?tree=Firefox"> Tinderbox</a></li>
<li><a title="Latest checkins" href="http://bonsai.mozilla.org/cvsqueryform.cgi"> Bonsai</a></li>
<li><a title="Source cross reference" href="http://lxr.mozilla.org/seamonkey/"> LXR</a></li>
</ul>
</li>
<li><a title="Frequently Asked Questions." href="../../faq.html"><strong> FAQs</strong></a></li>
</ul>

</div>
<hr class="hide">
<div id="mainContent">



  
                   
<h1>Demystifying Footprint</h1>
          Suresh Duddi &lt;dp@netscape.com&gt;<br>
                   
<hr width="100%" size="2"><small><i>Created: &nbsp;30 Jan 2002; Last Modified:
2 March 2002   </i></small>        
<h2>Glossary</h2>
       It is highly recommended that these terms are looked up and understood.<br>
       <br>
        <a
 href="http://www.memorymanagement.org/glossary/v.html#virtual.memory-1"><b>
       Virtual Memory</b></a><b> <br>
       <br>
       </b><b><a
 href="http://www.memorymanagement.org/glossary/w.html#working.set">    
Working Set</a></b> - The working set of a program or system is that <a
 href="http://www.memorymanagement.org/glossary/m.html#memory-2">    memory<sup><small>
   (2)</small></sup></a> or set of <a
 href="http://www.memorymanagement.org/glossary/a.html#address">     addresses</a>
   which it will use in the near future.<br>
        <br>
<b>max-working-set</b> - The union of all addresses accessed during a
        given time period {tbegin, tend}<p>
        <b><a
 href="http://www.memorymanagement.org/glossary/r.html#resident.set">   
 Resident Set</a></b> - In a <a
 href="http://www.memorymanagement.org/glossary/v.html#virtual.memory-1">
       virtual memory<sup><small>(1)</small></sup></a> system, a process
resident    set is that part of a process <a
 href="http://www.memorymanagement.org/glossary/a.html#address.space">  
  address space</a> which is currently in <a
 href="http://www.memorymanagement.org/glossary/m.html#main.memory">    
main memory</a>.  If this does not include all of the process <a
 href="http://www.memorymanagement.org/glossary/w.html#working.set">    
working set</a>, the system may <a
 href="http://www.memorymanagement.org/glossary/t.html#thrash">     thrash</a>
  . Usually this is the <a
 href="http://www.memorymanagement.org/glossary/w.html#working.set">    
Working Set</a>, plus other pages that the app used earlier that have  not
 been swapped to disk. Operating Systems decide when to swap unused pages
  of an app to disk. Mostly this decision is demand based - when other applications 
   need more physical memory and there is nothing free. Windows will swap 
out   all unused pages when an application is iconified.<br>
        <br>
       <b><a
 href="http://www.memorymanagement.org/glossary/t.html#thrash"> Thrash</a></b><br>
       <br>
        <b>Footprint</b> - can mean different things in different contexts. 
 For    example, on a machine without virtual memory, `footprint' would probably 
    mean `the maximum amount of physical memory that the application requires.<br>
        <br>
        Most modern operating systems have a Virtual Memory (VM) system that
  gives   each process its own Virtual Address Space. Only a part of the
virtual   memory   required by a process is paged into physical memory -
the part that  is required   now. This is called the Resident Set.<br>
          <br>
          Process address space can be broken down into:<br>
          <br>
                   
<table cellpadding="2" cellspacing="2" border="1">
            <tbody>
              <tr>
                <td valign="middle" align="center">Stack<br>
          grows<br>
          |<br>
          v<br>
                </td>
              </tr>
              <tr>
                <td valign="middle" align="center">^<br>
          |<br>
          grows<br>
          Heap<br>
                </td>
              </tr>
              <tr>
                <td valign="middle" align="center">static data<br>
                </td>
              </tr>
              <tr>
                <td valign="middle" align="center"><br>
          Code (lib)<br>
                <br>
                </td>
              </tr>
              <tr>
                <td valign="middle" align="center">Code (exe)<br>
                </td>
              </tr>
                                       
  </tbody>          
</table>
          <br>
     Usually,<br>
     <br>
     &nbsp;&nbsp;&nbsp; Virtual Memory &gt; Resident Set &gt; Working Set<br>
     <br>
     When physical memory available to the app becomes less than the
 apps Working Set, the app will thrash causing poor performance.<br>
               
<h2>Understanding the heap</h2>
  "heap" is mostly data allocated using malloc() and free(). When applications
 request for memory, the allocator (implementation of malloc and friends)
get VmData in bulk from the OS and manage it.<br>
  <br>
   
<table cellpadding="2" cellspacing="2" border="1" align="center">
    <tbody>
      <tr>
        <td valign="middle" align="center" bgcolor="#ffffcc"><b>Application<br>
        </b>Requests memory via calls to malloc()</td>
      </tr>
      <tr>
        <td valign="middle" align="center" bgcolor="#ffffcc"><b>Allocator 
      </b> - libc<br>
  Implements malloc()<br>
  Requests VmData from the OS using sbrk() or mmap() or VirtualAlloc()<br>
  in bulk and manages the memory returned.<br>
        </td>
      </tr>
      <tr>
        <td valign="middle" align="center" bgcolor="#6666cc"><b>Operating 
System</b>  - kernel<br>
  Manages physical memory and the mapping of individual processes' virutal
 memory into physical memory<br>
        </td>
      </tr>
       
  </tbody>  
</table>
  <br>
   
<h2>User Statement of the problem&nbsp;</h2>
             
<ol>
         <li><i>"When I run Netscape 6 for days on win98, I get alerts warning
   me of low virual memory"<br>
           <br>
           </i>This could be because swap file is small on win98. SWAP SIZE
 + Physical memory size caps total amount of Vm used by all applications.
So as processes use more Vm, we could hit this limit. It is really hard to
hit this limit on WinNT, 2000, XP or linux.<br>
           <i><br>
           </i></li>
         <li><i>"On my 32MB windows/linux machine, Netscape 6 is slow and 
sluggish"<br>
           <br>
           </i>This means that Netscape 6's working set for the user scenario
  is  high enough that it cannot be all held in physical memory and the sytem 
  thrashes  as it cycles through to satisfy Netscape 6's working set.<br>
           <br>
         </li>
         <li><i>"When Iconifying and deiconifying Netscape 6, it takes a
long   time  to become active"<br>
           <br>
           </i>When iconified on windows Nt/2000/XP, OS actively start swapping 
   out unused pages. When deiconified, all pages that are needed are swapped 
   back in as always. If the working set for deiconifying and displaying Netscape
   6 is large, a large amount of memory needs to be swapped back in and potentially
   in making room for that, that much memory needs to be swapped out of applications
   that are using it to disk. This could account for the delay in getting
Netscape   6 to become active again post deiconification. Also this will
account for   other apps being slower when Netscape 6 is running as it causes
them to trash  more.<br>
           <i><br>
           </i></li>
         <li><i>"Netscape 6 is too fat, consumes too much memory"</i><br>
           <br>
       This is a perception issue and has no real meaning to it.<br>
         </li>
             
</ol>
             
<h2>Ideal Metrics</h2>
       From the above statement of user problems and given the ideal tools
 that   can measure anything, these would be the numbers to measure and improve:<br>
             
<ol>
         <li><b>Max-working-set</b> : performance threshold<br>
      For a given scenario, union of the working set required by Netscape 6 
at every instant during the scenario. This number would say that on a machine 
 with backing store (swap), Netscape 6 needs this much physical memory available
  after the OS and other apps have been loaded to give the user a non-sluggish
  performance. This is a function of the process and not available physical
 memory (ie) for a given application and a senario, this is a constant number
 irrespective of what other apps are running or how much physical memory
is  available</li>
         <li><b>Peak-vm-usage </b>: pagesize threshold<br>
      For a given scenario, max vm requirement of Netscape6, assuming no
allocator buffering of virtual memory. Usually allocators dont return
virtual memory got from operating system ( via <i>sbrk()</i> ) unless
the unused VM is  greater than a threshold and is at the end of the processes'
VM space.<br>
         </li>
             
</ol>
             
<h2>Measurable Metrics</h2>
       <b>Max-working-set</b> We currently dont have the means to measure
 this. <i>We are working on it.</i><br>
       <br>
       <b>Peak-vm-usage</b>: This or a function of this can be measured reliably 
   but is Operating System and allocator dependent.<br>
       <br>
    <a name="User_Scenarios_for_measurement:"></a>   User Scenarios for measurement:<br>
             
<ol>
         <li>  Run pageload test : <a href="http://cowtools.mcom.com/">http://cowtools.mcom.com</a></li>
         <li>- Startup w/default profile, home.netscape.com<br>
       - Read 10 messages of 200 from netscape.net email using Imap<br>
       - Compose &amp; send one email<br>
         </li>
             
</ol>
             
<h2>Windows</h2>
  First let us see what each of the numbers reported by the various tools 
mean:<br>
   
<ol>
    <li>TaskManager : [Operating System] Task manage reports <b><a
 href="http://www.memorymanagement.org/glossary/r.html#resident.set">   
     </a></b><b><a
 href="http://www.memorymanagement.org/glossary/r.html#resident.set">Resident
 Set</a></b> Not much useful.</li>
    <li>Taskinfo 2000 : [Operating System] Reports total Vm Usage on 2000 
and VmCode/VmData breakdown on win98. VmCode includes static data. Gives VmCode
for each dll and the executable.</li>
    <li><a href="http://mozilla.org/projects/footprint/spaceTrace.html">
    SpaceTrace</a> : [Application] Reports peak heap requested by application.
 VmData is a direct function of heap requested by app - the allocator stands 
&nbsp;between the app and the system and request Vm in bulk. It also decides 
when to give back unused memory back to the OS.</li>
    <li><a href="heapinfo.html">HeapInfo</a> : [Allocator] Reports Vm requested
 by allocator from operating system on behalf of the application. Also reports
 a breakdown of usage of this memory. <b>win32 only</b><br>
    </li>
   
</ol>
   
<h2>Linux<br>
  </h2>
  On linux, say 21078 was the process id for netscape<br>
          <br>
          <samp> chetu&gt; grep Vm /proc/22049/status<br>
         <font color="#990000"> VmSize:    41844 kB</font><br>
         <strike> VmLck:         0 kB</strike><br>
         <font color="#3333ff"> VmRSS:     26260 kB</font><br>
         <font color="#990000"> VmData:    20316 kB</font><br>
         <strike> VmStk:        80 kB</strike><br>
         <strike> VmExe:       568 kB</strike><br>
         <font color="#990000"> VmLib:     17752 kB</font><br>
          <br>
          </samp>         
<table cellpadding="2" cellspacing="2" border="1" width="100%">
            <tbody>
              <tr>
                <td valign="top"><font color="#990000">VmSize</font><br>
                </td>
                <td valign="top">Virtual memory usage of entire process<br>
         = VmLib + VmExe + VmData + VmStk<br>
                </td>
              </tr>
              <tr>
                <td valign="top"><font color="#3333ff">VmRSS</font><br>
                </td>
                <td valign="top">Resident Set currently in physical memory
 including  Code, Data, Stack<br>
                </td>
              </tr>
              <tr>
                <td valign="top"><font color="#990000">VmData</font><br>
                </td>
                <td valign="top">Virtual memory usage of Heap<br>
                </td>
              </tr>
              <tr>
                <td valign="top">VmStk<br>
                </td>
                <td valign="top">Virtual memory usage of Stack. Doest change
  much.<br>
                </td>
              </tr>
              <tr>
                <td valign="top">VmExe<br>
                </td>
                <td valign="top">Virtual memory usage by executable and statically
     linked libraries <i>'man top' says this is broken ?</i><br>
                </td>
              </tr>
              <tr>
                <td valign="top"><font color="#990000">VmLib</font><br>
                </td>
                <td valign="top">Virtual memory usage by dlls loaded<br>
         </td>
        </tr>
               
  </tbody>    
</table>
   
<h2>Goal</h2>
           
<ol>
    <li><b>Reduce Peak-vm-usage : Peak-VmData and Peak-VmCode</b></li>
    <li><b>Reduce Peak-working-set</b></li>
           
</ol>
    for the <a href="#User_Scenarios_for_measurement:">user scenarios</a>
 in the  metric.<br>
      <br>
           
<h2>Plan</h2>
           
<table cellpadding="2" cellspacing="2" border="1" width="100%">
        <tbody>
          <tr>
            <th valign="top">Approach<br>
            </th>
            <th valign="top">Impact<br>
            </th>
            <th valign="top">Benefit<br>
            </th>
          </tr>
          <tr>
       <td valign="top">Release data no longer needed<br>
       </td>
       <td valign="top" align="center">data<br>
       </td>
       <td valign="top">Reduces peak vm usage. Frees more so allocator need 
not get more from OS. Reduces max-vm-usage<br>
       </td>
     </tr>
     <tr>
       <td valign="top">Reduce &lt;64 byte allocations<br>
       </td>
       <td valign="top" align="center">data<br>
       </td>
       <td valign="top">Reduces overhead.<br>
 Post startup: 15% of USED memory is consumed by overhead &nbsp;- data from 
      <a
 href="heapinfo.html">HeapInfo</a><br>
 Post startup: 78% (about 71,000) allocations are for &lt; 64 bytes - data 
from <a href="spaceTrace.html">SpaceTrace</a><br>
       </td>
     </tr>
     <tr>
            <td valign="top">Reducing memory churn<br>
            </td>
            <td valign="top" align="center">data<br>
            </td>
            <td valign="top"><b>This is performance not footprint. </b>Since 
fragmentation isnt high, this wont help footprint much.<br>
            </td>
          </tr>
                   <tr>
            <td valign="top">Reduce code<br>
            </td>
            <td valign="top" align="center">code<br>
            </td>
            <td valign="top"><b>Caution:</b> Focus on code needed for scenario
  rather than any code<br>
    This is going to be really hard to achieve for Mach-V Makes more sense
 for  embedding.<br>
            </td>
          </tr>
          <tr>
            <td valign="top">Delay load dlls<br>
            </td>
            <td valign="top" align="center">code<br>
            </td>
            <td valign="top">Reduces max-working-set and max-vm-usage<br>
            <b>Caution:</b> Delaying is useful only if the dll load can be
 postponsed  past the scenario<br>
            </td>
          </tr>
                   
  </tbody>        
</table>
      <br>
        
<h2>Notes on allocator</h2>
       
<h3>Windows 2000</h3>
       
<ul>
         <li>Uses a best-fit allocator</li>
         <li>Fragmentation is less than 4% of free space - not a problem</li>
         <li>Rarely releases free space back to operating system : HeapCompact()
 doesn't do much</li>
         <li>Doest use mmap() much</li>
         <li>Allocated blocks are aligned on 8 byte boundaries</li>
         <li>Malloc overhead is usually 8 to 16 bytes per block</li>
       
</ul>
       
<h3>Linux</h3>
       
<ul>
    <li>Uses ptmalloc - a derivative of Doug Lea's boundary tag allocator</li>
    <li>Allocated blocks are aligned on 8 byte boundaries</li>
    <li>Malloc overhead is 4 bytes per allocation.</li>
    <li>Minium allocated size is 16 bytes</li>
</ul>
                            
<h2>Recommended Reading</h2>
                          
<ul>
          <li>Doug Lea's boundary tag allocator (Linux malloc) : <a
 href="http://gee.cs.oswego.edu/dl/html/malloc.html">      http://gee.cs.oswego.edu/dl/html/malloc.html</a></li>
          <li>Dynamic Storage Allocation: A Survey and Critical Review :
    <a href="ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps">      ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps</a></li>
          <li><a
 href="http://developer.apple.com/techpubs/macosx/Essentials/Performance/VirtualMemory/Virtual_Mem_on_Mac_OS_X.html">
      http://developer.apple.com/techpubs/macosx/Essentials/Performance/VirtualMemory/Virtual_Mem_on_Mac_OS_X.html</a></li>
          <li><a
 href="http://developer.apple.com/techpubs/macosx/Essentials/Performance/VirtualMemory/Allocating__eing_Memory.html">
      http://developer.apple.com/techpubs/macosx/Essentials/Performance/VirtualMemory/Allocating__eing_Memory.html</a><br>
          </li>
                         
</ul>
                           
<hr width="100%" size="2"><br>
         <br>
                             



<hr class="hide">
</div>
</div>
<div id="footer">
<ul>
<li><a href="../../sitemap.html">Site Map</a></li>
<li><a href="../../security/">Security Updates</a></li>
<li><a href="../../contact/">Contact Us</a></li>
<li><a href="../../foundation/donate.html">Donate</a></li>
</ul>
<p class="copyright">
Portions of this content are &copy; 1998&#8211;2009 by individual mozilla.org
contributors; content available under a Creative Commons license | <a
href="http://www.mozilla.org/foundation/licensing/website-content.html">Details</a>.</p>
<p>
<span>Last modified June 27,  2006</span>
<span><a href="http://bonsai-www.mozilla.org/cvslog.cgi?file=mozilla-org/html/projects/footprint/footprint-guide.html&amp;rev=&amp;root=/www/">Document History</a></span>
</p>
</div>
</div>
</body>
</html>
