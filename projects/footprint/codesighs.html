<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<link rel="top" title="Home" href="http://www.mozilla.org/">
<link rel="stylesheet" type="text/css" href="../../css/print.css"  media="print">
<link rel="stylesheet" type="text/css" href="../../css/base/content.css"  media="all">
<link rel="stylesheet" type="text/css" href="../../css/cavendish/content.css" title="Cavendish" media="screen">
<link rel="stylesheet" type="text/css" href="../../css/base/template.css"  media="screen">
<link rel="stylesheet" type="text/css" href="../../css/cavendish/template.css" title="Cavendish" media="screen">
<link rel="icon" href="../../images/mozilla-16.png" type="image/png">

  <title>Codesighs</title>
           
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
  <meta name="DC.subject" content="Codesighs">
  <meta name="DC.title" content="Codesighs">
  <meta name="DC.description" content="Codesighs is a set of tools that help determine the code and 
  data size of shared libraries and executables and monitor their related drifts in size.">
  <meta name="DC.date.created" content="2002-10-18T16:51:03+11:00" scheme="W3CDTF">
  <meta name="DC.date.modified" content="2005-02-24T09:54:03+11:00" scheme="W3CDTF">
<script src="../../__utm.js" type="text/javascript"></script>
</head>
<body id="www-mozilla-org" class="deepLevel">
<div id="container">
<p class="important">You are currently viewing a snapshot of www.mozilla.org taken on April 21, 2008. Most of this content is
highly out of date (some pages haven't been updated since the project began in 1998) and exists for historical purposes only.  If
there are any pages on this archive site that you think should be added back to www.mozilla.org, please <a
href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Websites&component=www.mozilla.org">file a bug</a>.</p>
<p class="skipLink"><a href="#mainContent" accesskey="2">Skip to main content</a></p>
<div id="header">
<h1><a href="/" title="Return to home page" accesskey="1">Mozilla</a></h1>
<ul>
<li id="menu_aboutus"><a href="../../about/" title="Getting the most out of your online experience">About</a></li>
<li id="menu_developers"><a href="../../developer/" title="Using Mozilla's products for your own applications">Developers</a></li>
<li id="menu_store"><a href="http://store.mozilla.org/?r=mozorg1" title="Shop for Mozilla products on CD and other merchandise">Store</a></li>
<li id="menu_support"><a href="../../support/" title="Installation, trouble-shooting, and the knowledge base">Support</a></li>
<li id="menu_products"><a href="../../products/" title="All software Mozilla currently offers">Products</a></li>
</ul>
<form id="searchbox_002443141534113389537:ysdmevkkknw" action="http://www.google.com/cse" title="mozilla.org Search">
<div>
<label for="q" title="Search mozilla.org's sites">search mozilla:</label>
<input type="hidden" name="cx" value="002443141534113389537:ysdmevkkknw">
<input type="hidden" name="cof" value="FORID:0">
<input type="text" id="q" name="q" accesskey="s" size="30">
<input type="submit" id="submit" value="Go">
</div>
</form>
</div>
<hr class="hide">
<div id="mBody">
<div id="side">

<ul id="nav">
<li><a title="Roadmap" href="../../roadmap.html"><strong> Roadmap</strong></a></li>
<li><a title="Projects" href="../../projects/"><strong> Projects</strong></a></li>
<li><a title="For developers" href="../../developer/"><strong> Coding</strong></a>
<ul>
<li><a title="Module Owners" href="../../owners.html"> Module Owners</a></li>
<li><a title="Hacking" href="../../hacking/"> Hacking</a></li>
<li><a title="Get the Source" href="http://developer.mozilla.org/en/docs/Download_Mozilla_Source_Code"> Get the Source</a></li>
<li><a title="Building Mozilla" href="http://developer.mozilla.org/en/docs/Build_Documentation"> Build It</a></li>
</ul>
</li>
<li><a title="Testing" href="../../quality/"><strong> Testing</strong></a>
<ul>
<li><a title="Downloads of mozilla.org software releases" href="../../download.html"> Releases</a></li>
<li><a title="Latest mozilla builds for testers" href="../../developer/#builds"> Nightly Builds</a></li>
<li><a title="For testers to report bugs" href="https://bugzilla.mozilla.org/"> Report A Problem</a></li>
</ul>
</li>
<li><a title="Tools for mozilla developers" href="../../tools.html"><strong> Tools</strong></a>
<ul>
<li><a title="Bug tracking system for mozilla testers." href="https://bugzilla.mozilla.org/"> Bugzilla</a></li>
<li><a title="Latest status of mozilla builds" href="http://tinderbox.mozilla.org/showbuilds.cgi?tree=Firefox"> Tinderbox</a></li>
<li><a title="Latest checkins" href="http://bonsai.mozilla.org/cvsqueryform.cgi"> Bonsai</a></li>
<li><a title="Source cross reference" href="http://lxr.mozilla.org/seamonkey/"> LXR</a></li>
</ul>
</li>
<li><a title="Frequently Asked Questions." href="../../faq.html"><strong> FAQs</strong></a></li>
</ul>

</div>
<hr class="hide">
<div id="mainContent">







     
<h2>Codesighs Introduction</h2>    

<h3>What is Codesighs?</h3>
     
<p>Codesighs is a set of tools to help you determine the code and 
data size of shared libraries and executables. Once you can measure 
the code and data size, then you can measure drifts in size as code changes
occur.</p>
     
<h3>Why use Codesighs when we already have file size on disk?</h3>
     
<p>Codesighs does not look at the size on disk. Instead Codesighs 
relies upon symbol data made available by either the information in the file
itself or by a linker map file. Using this data, Codesighs can tell the
difference  between executable code and static data, and can also determine 
the size of the symbols involved (e.g. functions, static variables).<br><br>
File size on disk is an important metric for installers and for eyeballing 
size differences on large changes. Codesighs offers you the opportunity to
measure even minute changes that may show no difference in file size.</p>

<h3>A Short HOWTO</h3>
     
<p>If you are starting from an existing mozilla source tree:</p>
       
  <ul>
      <li>Set <b>MOZ_MAPINFO=1</b> in your build environment.</li>
      <li>cvs checkout mozilla/tools/codesighs</li>
      <li>Rerun mozilla/configure with your normal options, and in addition
 specify <b>--enable-codesighs</b>.</li>
      <li>If you are using a linux build:           
      <ul>
        <li>Run make in the mozilla/tools/codesighs directory.</li>
        <li>From the parent directory of the mozilla source tree, execute 
the following command: <b>./mozilla/tools/codesighs/autosummary.unix.bash
 results001.tsv results000.tsv summary001.txt</b></li>
      </ul>
      </li>
      <li>If you are using a windows build:
      <ul>
        <li>All .exe and .dll files need to be relinked, such that mapfile
 information is generated at link time. One way to do this is by rebuilding
 your entire tree; this will also build your mozilla/tools/codesighs directory.</li>
        <li>From the parent directory of the mozilla source tree, execute 
the following command form your bash shell: <b>./mozilla/tools/codesighs/autosummary.win.bash
 results001.tsv results000.tsv summary001.txt</b></li>
      </ul>
      </li>
      <li>See below for a description of these files and the output of the
 script.</li>
  </ul>

<p>Otherwise, if you are starting with no source tree:</p>
       
  <ul>
      <li>Set <b>MOZ_MAPINFO=1</b> in your build environment.</li>
      <li>Perform the normal source tree checkout steps.</li>
      <li>Enable <b>--enable-codesighs</b> by either placing in your .mozconfig
      file or by running configure manually.</li>
      <li>Proceed with the normal build steps.</li>
      <li>If you are using a linux build:
      <ul>
        <li>From the parent directory of the mozilla source tree, execute 
        the following command: 
<b>./mozilla/tools/codesighs/autosummary.unix.bash results001.tsv results000.tsv summary001.txt</b>
        </li>
      </ul>
      </li>
      <li>If you are using a windows build:
      <ul>
        <li>From the parent directory of the mozilla source tree, execute 
the following command form your bash shell: <b>./mozilla/tools/codesighs/autosummary.win.bash
 results001.tsv results000.tsv summary001.txt</b></li>
      </ul>
      </li>
      <li>See below for a description of these files and the output of the
 script.</li>
  </ul>

<p>The script itself will first output a single number which represents the
total  size of all code and data in the considered executable build files.<br><br>

The script may output a second number which represents the composite size
difference  from the results000.tsv file to the results001.tsv file, but
only if the file results000.tsv is present.<br><br>

The file results000.tsv does not need to exist beforehand, but go ahead
specify it anyway. If it does exist, it should be the results of a
prior run of the script (i.e. results001.tsv). By using prior results
of the script you can see the differences any source code changes applied 
to your tree have caused.<br><br>

The file results001.tsv will be overwritten to contain all symbol data
garnered  form the build. Use this file in the future as the results000.tsv
file  to see the differences any source code changes you apply to the source
tree cause. If interested, take a look at this file. The file
contains all symbols found sorted by their respective sizes. This information
could be a good starting point if you  are interested in reducing the code
or data footprint of the build.<br><br>

The file summary001.txt will contain any code or data size differences
between results000.tsv and results001.tsv. In addition, this file
will give a brief summary of the code and data sizes of the modules in the
build.</p>
  
<h3>A Longer Introduction</h3>
   
<p>Once you havve performed the steps in the shorter HOWTO and are
interested in the niceties, this section is for you. By explaining
each Codesighs tool separately, I hope to empower you to wield or modify
them as you will. Also, simply reading the autosummary.*.bash scripts
will cover almost everything I will state below.</p>
       
  <ul>
      <li>msmap2tsv</li>
  </ul>
       
<p>This command takes a MS linker .map file and converts it into
a format which codesighs understands.<br><br>

As a warning, the symbol sizes this tool reports are not guaranteed. The 
.map files produced by the MS linker do not specify sizes of the symbols,
but instead give offsets of the symbols in particular sections. msmap2tsv
uses these offsets and sections as clues to a symbol's size. All code
and data is accounted for, but the guesswork may improperly report some
symbol sizes. Some incorrect symbol sizes will include static functions
which  are in the source file near the public reported symbol.<br><br>

Here is a list of sections a .map file might contain. Knowing the 
various sections can come in handy when trying to determine what the tool 
output represents. In short, these sections control whether or not the
size of each section is attributed to code or data:</p>
    <ul>
        <li>bss: uninitialized data.</li>
        <li>crt: runtime library initialization/shutdown pointers.</li>
        <li>data: initialized data.</li>
        <li>debug: COFF debug information data.</li>
        <li>edata: exported functions data.</li>
        <li>idata: imported functions data.</li>
        <li>rdata: read only data.</li>
        <li>reloc: base relocations data.</li>
        <li>rsrc: resource data.</li>
        <li>text: machine code.</li>
    </ul>

<p>Further, the sections reported in the .map file may not be present in  the
resultant executable. This is a positive result, as they are merged
by the linker and will cause less overhead; each section uses at least 4k
of system memory even if only 1 byte of the section is utilized. For
example, the edata and idata sections are normally merged with the rdata
section, bss is normally merged with the data section, et. al. MSDN
has some articles regarding  merging of sections. If you see too many sections
via a "dumpbin /summary &lt;filename.exe&gt;" then perhaps one way to reduce
physical memory strain  is to merge some of the sections.<br><br>

Another thing to consdier is that at the time of this writing, msmap2tsv
does not demangle the symbol names reported in the mapfile. This can
make it slightly more difficult to recognize C++ symbols. On the other
hand, nm2tsv does demangle the names if you are using a linux build.</p>

  <ul>
      <li>nm2tsv</li>
  </ul>
       
<p>This command takes the output of the GNU nm tool and converts
it into a format which codesighs understands.<br><br>

Specifically, the options to the nm tool should be: --format=bsd
--size-sort  --print-file-name --demangle<br><br>

The requirement for nm to be from GNU comes from some hard coded interpretations
regarding the symbol type. The symbol types are used in helping to
determine whether the symbol is code or data. Knowing these symbol
types can help in understanding the output of this tool. Some of the
types are as:</p>
           
    <ul>
        <li>B: uninitialized data</li>
        <li>D: initialized data</li>
        <li>R: read only data</li>
        <li>T: machine code</li>
        <li>V: weak object</li>
        <li>W: weak symbol</li>
    </ul>

<p>Because the nm tool reports the size of each symbol when the --size-sort
switch is used, no guesswork is performed by this tool with regards to the
symbol size.</p>
       
  <ul>
      <li>codesighs</li>
  </ul>
   
<p>This tool takes the output from msmap2tsv or nm2tsv and outputs 
total sums regarding code and data size by module.<br><br>

While researching various aspects of the tsv data, this tool is the easiest 
research tool available.<br><br>

This tool has a lot of command line options. Short of importing the
tsv output into a database to perform queries against, this tool is your best
option. You can specify a fairly verbose query using the command line.<br><br>

For instance, if you were interested in the import and export symbol sizes
of a win32 build, you would perform the following command: <b>codesighs.exe
--match-section idata --match-section edata --input somefile.tsv</b> The
results of this command would show you the overhead incurred from importing
and exporting functions on win32.<br><br>

Here's a hypothetical sample of the output of this tool using the switches 
"--modules --match-module mozilla --match-module xpcom --match-module nspr" 
on a tsv file generated from every mapfile found in the source tree:</p>
     
<pre>Overall Size<br>        Total:     4886384<br>        Code:      1304442<br>        Data:      3581942<br><br>xpcom<br>        Total:     4364095<br>        Code:       948124<br>        Data:      3415971<br><br>nspr4<br>        Total:      216929<br>        Code:       175202<br>        Data:        41727<br><br>mozilla<br>        Total:      211255<br>        Code:       102283<br>        Data:       108972<br><br>nsprefm<br>        Total:       94105<br>        Code:        78833<br>        Data:        15272</pre>
   
  <ul>
      <li>maptsvdifftool</li>
  </ul>
   
<p>This tool is used to output a human readable change summary 
of code and data size drifts. Used mainly in the autosummary.*.bash 
scripts to show drifts after changes to a source tree occur, it is possible 
to get the same results by hand.<br><br>

These steps are vague in nature, but you should be able to follow them and 
you will have a custom drift report in no time:</p>
     
    <ul>
       <li>Run nm2tsv on a binary or msmap2tsv on a mapfile to produce some 
tsv output. Do this to as many mapfiles or binaries as you see fit to
produce the right tsv output.</li>
       <li>Sort the tsv output and save it away somewhere.</li>
       <li>Make whatever build changes you have in mind, and then reproduce 
the tsv output and sort it.</li>
       <li>Diff the first tsv output with the second tsv output.</li>
       <li>Run the diff results through maptsvdifftool to see the deltas
in a human readable form.</li>
      <li>If there was no change, consider using the <b>--zero-drift</b>
command line argument which will show all changes even if they result in
a net zero change. This option will show you every minute change made
to the symbols.</li>     
    </ul>

<p>Here's a hypothetical sample of the output of this tool:</p>
     
<pre>Overall Change in Size<br>        Total:        +6628<br>        Code:         +4133<br>        Data:         +2495<br><br>codesighs<br>        Total:        +6628<br>        Code:         +4133<br>        Data:         +2495<br>              +4133     text (CODE)<br>                      +4112     codesighs.obj<br>                              +2192     _initOptions<br>                               +992     _cleanOptions<br>                               +928     _codesighs<br>                        +21     MSVCRTD:MSVCRTD.dll<br>                                 +6     _strstr<br>                                 +6     _strtoul<br>                                 +6     __errno<br>                                 +5     __strdup<br>                                 -2     _printf<br>              +2430     data (DATA)<br>                      +2432     UNDEF:codesighs:data<br>                              +2432     UNDEF:codesighs:data<br>                         -2     MSVCRTD:merr.obj<br>                                 -2     ___defaultmatherr<br>                +33     idata$6 (DATA)<br>                        +33     UNDEF:codesighs:idata$6<br>                                +33     UNDEF:codesighs:idata$6<br>                +16     idata$4 (DATA)<br>                        +16     UNDEF:codesighs:idata$4<br>                                +16     UNDEF:codesighs:idata$4<br>                +16     idata$5 (DATA)<br>                        +16     MSVCRTD:MSVCRTD.dll<br>                                 +4     __imp__strstr<br>                                 +4     __imp__strtoul<br>                                 +4     \177MSVCRTD_NULL_THUNK_DATA<br>                                 +4     __imp___errno<br></pre>
 
<hr>

<div class="author">Garrett Arch Blythe, blythe@netscape.com</div>



<hr class="hide">
</div>
</div>
<div id="footer">
<ul>
<li><a href="../../sitemap.html">Site Map</a></li>
<li><a href="../../security/">Security Updates</a></li>
<li><a href="../../contact/">Contact Us</a></li>
<li><a href="../../foundation/donate.html">Donate</a></li>
</ul>
<p class="copyright">
Portions of this content are &copy; 1998&#8211;2009 by individual mozilla.org
contributors; content available under a Creative Commons license | <a
href="http://www.mozilla.org/foundation/licensing/website-content.html">Details</a>.</p>
<p>
<span>Last modified February 24,  2005</span>
<span><a href="http://bonsai-www.mozilla.org/cvslog.cgi?file=mozilla-org/html/projects/footprint/codesighs.html&amp;rev=&amp;root=/www/">Document History</a></span>
</p>
</div>
</div>
</body>
</html>
