
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<link rel="top" title="Home" href="http://www.mozilla.org/">
<link rel="stylesheet" type="text/css" href="../../../css/print.css"  media="print">
<link rel="stylesheet" type="text/css" href="../../../css/base/content.css"  media="all">
<link rel="stylesheet" type="text/css" href="../../../css/cavendish/content.css" title="Cavendish" media="screen">
<link rel="stylesheet" type="text/css" href="../../../css/base/template.css"  media="screen">
<link rel="stylesheet" type="text/css" href="../../../css/cavendish/template.css" title="Cavendish" media="screen">
<link rel="icon" href="../../../images/mozilla-16.png" type="image/png">

   <TITLE>How To Add Additional Charset Support</TITLE>
<script src="../../../__utm.js" type="text/javascript"></script>
</head>
<body id="www-mozilla-org" class="deepLevel">
<div id="container">
<p class="important">You are currently viewing a snapshot of www.mozilla.org taken on April 21, 2008. Most of this content is
highly out of date (some pages haven't been updated since the project began in 1998) and exists for historical purposes only.  If
there are any pages on this archive site that you think should be added back to www.mozilla.org, please <a
href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Websites&component=www.mozilla.org">file a bug</a>.</p>
<p class="skipLink"><a href="#mainContent" accesskey="2">Skip to main content</a></p>
<div id="header">
<h1><a href="/" title="Return to home page" accesskey="1">Mozilla</a></h1>
<ul>
<li id="menu_aboutus"><a href="../../../about/" title="Getting the most out of your online experience">About</a></li>
<li id="menu_developers"><a href="../../../developer/" title="Using Mozilla's products for your own applications">Developers</a></li>
<li id="menu_store"><a href="http://store.mozilla.org/?r=mozorg1" title="Shop for Mozilla products on CD and other merchandise">Store</a></li>
<li id="menu_support"><a href="../../../support/" title="Installation, trouble-shooting, and the knowledge base">Support</a></li>
<li id="menu_products"><a href="../../../products/" title="All software Mozilla currently offers">Products</a></li>
</ul>
<form id="searchbox_002443141534113389537:ysdmevkkknw" action="http://www.google.com/cse" title="mozilla.org Search">
<div>
<label for="q" title="Search mozilla.org's sites">search mozilla:</label>
<input type="hidden" name="cx" value="002443141534113389537:ysdmevkkknw">
<input type="hidden" name="cof" value="FORID:0">
<input type="text" id="q" name="q" accesskey="s" size="30">
<input type="submit" id="submit" value="Go">
</div>
</form>
</div>
<hr class="hide">
<div id="mBody">
<div id="side">

<ul id="nav">
<li><a title="Roadmap" href="../../../roadmap.html"><strong> Roadmap</strong></a></li>
<li><a title="Projects" href="../../../projects/"><strong> Projects</strong></a></li>
<li><a title="For developers" href="../../../developer/"><strong> Coding</strong></a>
<ul>
<li><a title="Module Owners" href="../../../owners.html"> Module Owners</a></li>
<li><a title="Hacking" href="../../../hacking/"> Hacking</a></li>
<li><a title="Get the Source" href="http://developer.mozilla.org/en/docs/Download_Mozilla_Source_Code"> Get the Source</a></li>
<li><a title="Building Mozilla" href="http://developer.mozilla.org/en/docs/Build_Documentation"> Build It</a></li>
</ul>
</li>
<li><a title="Testing" href="../../../quality/"><strong> Testing</strong></a>
<ul>
<li><a title="Downloads of mozilla.org software releases" href="../../../download.html"> Releases</a></li>
<li><a title="Latest mozilla builds for testers" href="../../../developer/#builds"> Nightly Builds</a></li>
<li><a title="For testers to report bugs" href="https://bugzilla.mozilla.org/"> Report A Problem</a></li>
</ul>
</li>
<li><a title="Tools for mozilla developers" href="../../../tools.html"><strong> Tools</strong></a>
<ul>
<li><a title="Bug tracking system for mozilla testers." href="https://bugzilla.mozilla.org/"> Bugzilla</a></li>
<li><a title="Latest status of mozilla builds" href="http://tinderbox.mozilla.org/showbuilds.cgi?tree=Firefox"> Tinderbox</a></li>
<li><a title="Latest checkins" href="http://bonsai.mozilla.org/cvsqueryform.cgi"> Bonsai</a></li>
<li><a title="Source cross reference" href="http://lxr.mozilla.org/seamonkey/"> LXR</a></li>
</ul>
</li>
<li><a title="Frequently Asked Questions." href="../../../faq.html"><strong> FAQs</strong></a></li>
</ul>

</div>
<hr class="hide">
<div id="mainContent">





<CENTER>
<H1>
How To Add Additional Charset Support</H1></CENTER>

<CENTER>Incompleted Draft: April 20,1998</CENTER>
<CENTER>Contact: Frank Tang 
&lt;<A HREF="mailto:ftang@netscape.com">ftang@netscape.com</A>&gt;</CENTER>

<CENTER>Discussion: <A HREF="news://news.mozilla.org/netscape.public.mozilla.i18n">netscape.public.mozilla.i18n</A> or
<A HREF="mailto:mozilla-i18n@mozilla.org">mozilla-i18n@mozilla.org</A></CENTER>


<CENTER>
<HR WIDTH="100%"></CENTER>

<H1>
Tasks Outline:</H1>

<H2>
In Cross-platform code:</H2>

<UL>
<LI>
<A HREF="#csid">Add CharSetID with the property of the charset</A>.</LI>

<LI>
<A HREF="#mimecharsetname">Associate CharSetID with MIME charset name and
Java Encoding Name</A>.</LI>

<LI>
<A HREF="#unicode conversion">Add Unicode conversion tables</A>.</LI>

<LI>
<A HREF="#conversion">Add additional codeset conversion support</A>.</LI>

<LI>
<A HREF="#conversionrule">Add codeset conversion rules</A>.</LI>

<LI>
<A HREF="addcharset.html#nencr">Add ASCII fallback for Name Entity or Numeric
Character Reference Not Supported in this Charset.</A></LI>

<LI>
<A HREF="#charlen">Add character length and column width information for
multibyte charset</A>.</LI>

<LI>
<A HREF="#casetransform">Add (pseudo) toLower table for case-insensitive
folding</A>.</LI>

<LI>
<A HREF="#wordlinebreak">Add line breaking prohibit information for multibyte
charset</A>.</LI>

<LI>
<A HREF="#wordbreak">Add word breaking information for multibyte charset</A>.</LI>
</UL>

<H3>
In Window Code:</H3>

<UL>
<LI>
<A HREF="#wincodepage">Add CodePage to CharSetID mapping</A></LI>

<LI>
<A HREF="#winsinglebyte">Add Single Byte Conversion Table</A></LI>

<LI>
<A HREF="#winunicodetable">Add Unicode Conversion Tables</A></LI>

<LI>
<A HREF="#winencodingmenu">Add menu items to "View:Encoding" menu</A></LI>

<LI>
<A HREF="#winfont">Add menu item for "Font" preference "For the Encoding"
menu</A></LI>
</UL>

<H3>
In Macintosh Code:</H3>

<UL>
<LI>
<A HREF="#macscript">Add Script to CharSetID mapping</A></LI>

<LI>
<A HREF="#macsinglebyte">Add Single Byte Conversion Table</A></LI>

<LI>
<A HREF="#macunicode">Add Unicode Conversion Table</A></LI>

<LI>
<A HREF="#macencodingmenu">Add menu item to "View:Encoding" menu</A></LI>

<LI>
<A HREF="#macfont">Add menu item for "Font" Preference "For the Encoding"
menu</A></LI>
</UL>

<H3>
In UNIX Code:</H3>

<UL>
<LI>
<A HREF="addcharset.html#unixfont">Add font handling code</A></LI>

<LI>
<A HREF="#unixsinglebyte">Add Single Byte Conversion Table</A></LI>

<LI>
<A HREF="#unixunicode">Add Unicode Conversoin Table</A></LI>

<LI>
<A HREF="#unixencoding">Add menu item to "View:Encoding" menu</A></LI>
</UL>

<HR WIDTH="100%">
<H1>
Details</H1>

<H2>
In Cross-Platform Code</H2>

<H3>
<A NAME="csid"></A>1. Add CharSetID with the property of the charset.</H3>
<H4>A. Decide the property of the charset you need to add:</H4>
<UL>
<LI>
Type- one of the following four:</LI>

<UL>
<LI>
SINGLEBYTE- for single byte charset, such as KOI8-R, ISO-8859-x, TIS620</LI>

<LI>
MULTIBYTE- for muiltibyte charset, such as Shift_JIS, EUC-KR</LI>

<LI>
WIDECHAR- for process code, such as UCS2, UCS4</LI>

<LI>
STATEFUL- for stateful encoding, like ISO-2022-JP, ISO-2022-KR</LI>
</UL>

<LI>
Basic line wrapping rule (only for MULTIBYTE): CS_SPACE- wrap line in spacing
character only. Currently only Korean.</LI>
</UL>
<H4>B. Define your CharSetID in file <TT>include/csid.h</TT></H4>
<H3>
<A NAME="mimecharsetname"></A>2. Associate CharSetID with MIME charset
name and Java Encoding Name.</H3>
You need to do this for every CharSetID you add.
<H4>
Procedure:</H4>
A. Before you add any name, please look at two document first:
<UL>
<LI>
<A HREF="ftp://ftp.isi.edu/in-notes/iana/assignments/character-sets">IANA
(Internet Assigned Numbers Authority) CHARACTER SET</A> document.</LI>

<LI>
<A HREF="http://java.sun.com/products/jdk/1.1/docs/guide/intl/intl.doc.html#25303">"Supported
Encodings" section in the Java "JDK Internationalization Overview"</A>
document.</LI>
</UL>
B. Decide the following:
<UL>
<LI>
MIME charset name- use the one labeled as "(Preferred MIME name)" in the
IANA document. If there are no one in the IANA document, you should:</LI>

<UL>
<LI>
Considering register one to IANA</LI>

<LI>
Put "x-" in the beginning to indicate it is a private one.</LI>
</UL>

<LI>
MIME charset aliases - all the name and alias for that CharSetID listed
in the IANA document.</LI>

<LI>
Java encoding name - the name list in the Java document</LI>
</UL>
C. Open file <TT>lib/libi18n/csnametb.c</TT> , add entries to the csname2id_tbl.
Only the first entry for that CharSetID will be used to map from a CharSetID
to a MIME Charset or Java encoding name. The rest of the entries will be
used only to map a MIME Charset alias to a CharSetID. For example, here
are the entries for Japanese Shift_JIS charset:
<PRE>
  {"Shift_JIS", "SJIS", CS_SJIS},
  ...
  /* aliases for Shift_JIS: */
  {"x-sjis", "", CS_SJIS},
  {"ms_Kanji", "", CS_SJIS},
  {"csShiftJIS", "", CS_SJIS},
  {"Windows-31J", "", CS_SJIS},
</PRE>
in the above example, where
<UL>
<LI>
CS_SJIS is the CharSetID</LI>

<LI>
"Shift_JIS" is the MIME charset name so it is listed in the first entry,</LI>

<LI>
"SJIS" is the Java encoding name,</LI>

<LI>
"x-sjis", "ms_Kanji", "csShiftJIS", and "Windows-31J" are the MIME charset
aliases. Although "x-sjis" is not listed in the IANA document but we listed
it for backward compatability reason.</LI>
</UL>

<H4>
<A NAME="unicode conversion"></A>3. Add Unicode conversion tables.</H4>
A. Create the conversion table:
Before create a conversion table for your charset, take a look at the directory 
lib/libi18n/unicode/ufrmtbl and lib/libi18n/unicode/utotbl. You may find the one
for your charset is already there, even they are not build into the mozilla
binary.  If you cannot find one there, follow the instruction below. 
(Thanks for Hovik Melikyan &lt;hovik@undp.am&gt; to write the following section for me)
<P>
A.1. Create a 8 to 16-bit conversion table for the new encoding. The file
should contain two columns of hexadecimal numbers, where the left column
represents 8-bit codes and the right column - corresponding 16-bit code. If there are some 
undefined code point or code point have no mapping to Unicode, do not list it in the file. Example:
<PRE>
   0x20    0x0020
   ...
   0xa0    0x00a0
   0xa2    0x00a7
   0xa3    0x0589
   0xa4    0x0029
   ...
</PRE>
This file will be used for generating both "FROM" and "TO" conversion
tables.
<P>
A.2. Compile utilities in lib/libi18n/unicode/tbltool. Example for Visual
C++:
<PRE>
    cl -I../../ fromu.c utblutil.c
    cl -I../../ tou.c utblutil.c
</PRE>
These programs accept conversion tables as described in A.1. from standard
input and generate resources to standard output in a form suitable for
including in Windows resource files and also UNIX C sources. Example:
<PRE>
  fromu < xscii.txt > xscii.uf
  tou < xcsii.txt > xscii.ut
</PRE>
A.3 Copy the generated *.uf and *.ut files to lib/libi18n/unicode/ufrmtbl and
lib/libi18n/unicode/utotbl respectively.
<P>
B. Include the Unicode conversion table into the binary by do the following:
<UL>
<LI><A HREF="#winunicodetable">Window</A>
<LI><A HREF="#macunicode">Macintosh</A>
<LI><A HREF="#unixunicode">UNIX</A>
</UL>
<P>
C. You might also need to make additions to shift tables in
lib/libi18n/ugendata.c
<H4>
<A NAME="conversion"></A>4. Add additional codeset conversion support.</H4>
<FONT SIZE=+3>[To Be Written]</FONT>
<BR>How to write a new conversion routine.
<H4>
<A NAME="conversionrule"></A>5. Add codeset conversion rules.</H4>
<FONT SIZE=+3>[To Be Written, IDEA and OUTLINE only for now]</FONT>
<BR>How to change lib/libi18n/fe_ccc.c

<P>Outline:
<UL>
<LI>
For multibyte charset, if the from and to CharSetID are the same, apply
mz_mbNullConv with a flag</LI>

<LI>
Fro singlebyte charset, if the from and to CharSetID are the ame, cast
0.</LI>

<LI>
For other singlebyte charset, apply One2OneCCC routine.Remember to link
to the FE section about singlebyte table.</LI>

<LI>
For algorithm base conversion, write a new conversion routine if it is
algorithm base. Refer to previous section.</LI>

<LI>
If it is desired to use Unicode as intermediate code for the conversion,
use mz_AnyToAnyThroughUCS2 .</LI>

<LI>
Need to have conversion rule for both direction so HTML Form posting will
work.</LI>
</UL>

<H4>
<A NAME="nencr"></A>6. Add ASCII fallback for Name Entity or Numeric Character
Reference Not Supported in this Charset</H4>
If you want to add ASCII fallback for the Name Entity or Numeric Character
References for the newly added charset, you should do this step:
<H4>
Procedure:</H4>
Open file <TT>lib/libparse/pa_amp.c</TT>, locate the function pa_map_escape
and goto the end of this function. There should be #ifdef PLATFORM section
which have a big switch statement there, add your code there to provide
different ASCII fallback for character you cannot display in the font CharSetID.
<H4>
<A NAME="charlen"></A>7. Add character length/column width information
for multibyte charset.</H4>
If the font or document CharSetID you add is multibyte charset. You should
provide character/column length information as below.
<H4>
Procedure:</H4>
A. Open <TT>lib/libi18n/csstrlen.c</TT> , locate the csinfo_tbl in the
beginning of the file. Look at the current entry, add addition entry
if no entry match the characteristic of your charset. Here is the entry
for Japanese EUC_JP charset.
<PRE>
    {{{2,2,{0xa1,0xfe}}, {2,1,{0x8e,0x8e}}, {3,2,{0x8f,0x8f}}}}, /* For EUC_JP */
</PRE>
This entry specify if the first byte of a character is
<UL>
<LI>
in the range of 0xa1 to 0xfe, the character length is 2 bytes and the column
width is 2 columns (For 2 byte JIS x0208 characters),</LI>

<LI>
0x8e, the character length is 2 bytes and the column width is 1 columns
(For JIS x0201 katakana, there are a SS2 [0x8e] in front of the one byte
katakana),</LI>

<LI>
0x8f, the character length is 3 bytes and the column width is 2 columns
(For JIS x0212 characters, threre are a SS3 [0x8f] in front of the two
byte kanji)</LI>

<LI>
the rest of the code point is one byte character</LI>
</UL>
B. In the same file, register your entry by change the value in the csinfoindex
table, where the value is the index of the entry you just add, (for EUC_JP,
it is 1 in csinfo_tbl) and the entry you should change is the sequential
number of the CharSetID, (for EUC_JP, it is 5 defined in include/csid.h).
Value -1 indicate it is single byte charset which character length and
column width are always 1.
<BR>
<H4>
<FONT COLOR="#FF0000">To Be Improved</FONT></H4>

<UL>
<LI>
<FONT COLOR="#FF0000">Break the limitation of only 256 charset could be
defined.</FONT></LI>

<LI>
<FONT COLOR="#FF0000">Remove the assumption of CharSetID.</FONT></LI>
</UL>

<H4>
<A NAME="casetransform"></A>8. Add (pseudo) toLower table for case-insensitive
folding.</H4>
You need to add tables to one of the following files to perform correct
case-insensitive search. It is only need to be done for the font CharSetID.
A document CharSetID which is not a font CharSetID in that platform do
not need do this.
<H4>
Procedure:</H4>
A. If the charset you add is single byte charset:
<BR>A.1 open file <TT>lib/libi18n/sblower.c</TT> ,
<BR>A.2 Add (pseudo) to-lower-case table for the code point 0x80-0xFF.
To reduce size in the platform which do not use the charset as font CharSetID,
put #ifdef PLATFORM around the new table.
<BR>A.3 Change function INTL_GetSingleByteToLowerMap to return the new
(pseudo) to-lower-case table.

<P>B. If the charset you add is multibyte charset:
<BR>B.1 open <TT>lib/libi18n/dblower.c</TT>,
<BR>B.2 add (pseudo) double-bytes to-lower-mapping table. To reduce
size in the platform which do not use the charset as font CharSetID, put
#ifdef PLATFORM around the new table. The table entry is defined as
<PRE>
    typedef struct {
         unsigned char src_b1;
         unsigned char src_b2_start;
         unsigned char src_b2_end;
         unsigned char dest_b1;
         unsigned char dest_b2_start;
    } DoubleByteToLowerMap;
</PRE>
B.3 Change function INTL_GetDoubleByteToLowerMap to return the new (pseudo)
to-lower-case table.
<H4>
<A NAME="wordlinebreak"></A>9. Add line breaking prohibit information for
multibyte charset.</H4>
Line wrapping behavior is affected by the following property of CharSetID:
<UL>
<LI>
Type of CharSetID- SINGLEBYTE or MULTIBYTE</LI>

<LI>
CS_SPACE bit in CharSetID</LI>

<LI>
Prohibit type of the character returned by funcion INTL_KinsokuClass.</LI>
</UL>
It is difficult to describe how to change it. Take a look at the layout
code to change the behavior. For multibyte charsest, INTL_KinsokuClass
function play a big role. It return one of four prohibit type:
<UL>
<LI>
PROHIBIT_WORD_BREAK: Do not wrap line in between two character which have
this prohibit type. For example, the Greek characters in UTF-8 have this
type so yo won't wrap in between two Greek character.</LI>

<LI>
PROHIBIT_NOWHERE: It is ok to break before or after this character. For
example, all the Kanji character have this type.</LI>

<LI>
PROHIBIT_BEGIN_OF_LINE: This character should not appeared in the beginning
of the line. Do not warp line before it. For example, ')' has this type.</LI>

<LI>
PROHIBIT_END_OF_LINE: This character should not appeared in the end of
the line. Do not warp line after it. For example, '(' has this type.</LI>
</UL>

<H4>
Procedure:</H4>
To change INTL_KinsokuClass, change file <TT>lib/libi18n/kinsokuf.c</TT>
and <TT>lib/libi18n/kinsokud.c</TT>
<H4>
References:</H4>

<UL>
<LI>
Ken Lunde, Understanding Japanese Information Processing, page 148-151</LI>

<LI>
Japanese Standards Association, JIS X 4051-1995, Line composition rules
for Japanese documents.</LI>

<LI>
Nadine Kano, Developing International Software For Windows 95 and Windows
NT, page 238-245</LI>
</UL>

<H4>
<FONT COLOR="#FF0000">To Be Improved:</FONT></H4>

<UL>
<LI>
<FONT COLOR="#FF0000">This API should be changed to optimize the performance,
at state machine implmentation should do better job.</FONT></LI>

<LI>
<FONT COLOR="#FF0000">It will be great if we could make the prohibit list
changable by the document in HTML tag.</FONT></LI>
</UL>

<H4>
10.<A NAME="wordbreak"></A>Add word breaking information for multibyte
charset.</H4>
This is for word selection (by double click) feature.
<H4>
Procedure:</H4>
Open file and change the function INTL_CharClass. It is hard to explain
how to change it. Look at by yourself.
<H4>
<FONT COLOR="#FF0000">To be improved:</FONT></H4>

<UL>
<LI>
<FONT COLOR="#FF0000">We should rewrite this function to include more class.</FONT></LI>

<LI>
<FONT COLOR="#FF0000">An extensable mechanism is needed.</FONT></LI>

<LI>
<FONT COLOR="#FF0000">There are no way to do dictionary-base word break.</FONT></LI>
</UL>

<H4>

<HR WIDTH="100%"></H4>

<H2>
In Window Code</H2>

<H4>
1.<A NAME="wincodepage"></A>Add CodePage to CharSetID mapping</H4>
You need to do the following if you add additional font CharSetID. This
have to be done so a Window code page number could be map to the new CharSetID.
You don't need to do this if you only add addition CharSetID for document
CharSetID and use the existing CharSetID as font CharSetID.
<H4>
Procedure:</H4>
Open file <TT>cmd/winfe/intlwin.cpp</TT>, and locate for function <TT>CIntlWin::CodePageToCsid</TT>
, add code there if necessary. That function map a Window code page to
a CharSetID you defined in <TT>ns/include/csid.h</TT>
<H4>
<FONT COLOR="#FF0000">To Be Improved:</FONT></H4>
<B><FONT COLOR="#FF0000">The current implementation should be improved
in near future by moving such mapping into resoruce so no C code need to
be changed.</FONT></B>
<H4>
2.<A NAME="winsinglebyte"></A>Add Single Byte Conversion Table</H4>
If the CharSetID you add is a single byte charset and you want to use One2One
conversion procedure to convert between font CharSetID and document CharSetID
on Window, you need to do this step.
<H4>
Procedure:</H4>
Open file cmd/winfe/res/convtbls.rc and add lines:

<PRE>
    <B><I>MIMECharsetFrom_TO_MIMECharsetTo</I></B> RCDATA
    BEGIN
    <B><I><FONT COLOR="#FF0000">/*8x*/  0x8180, 0x8382, 0x8584, 0x8786, 0x8988, 0x8B8A, 0x8D8C, 0x8F8E,
    /*9x*/  0x9190, 0x9392, 0x9594, 0x9796, 0x9998, 0x9B9A, 0x9D9C, 0x9F9E,
    /*Ax*/  ..............................................................
    /*Bx*/  ..............................................................
    /*Cx*/  ..............................................................
    /*Dx*/  ..............................................................
    /*Ex*/  ..............................................................
    /*Fx*/  ..............................................................
    </FONT></I></B>END /* End of <B><I>MIMECharsetFrom_TO_MIMECharsetTo</I></B> */
</PRE>
where
<UL>
<LI>
<B><TT><I>MIMECharsetFrom_TO_MIMECharsetTo</I> </TT></B>is the RESOURCE
ID for the table. You must code this RESOURCE ID as <TT><B><I>MIMECharsetFrom</I></B>_TO_<B><I>MIMECharsetTo</I></B></TT><B>
</B>, where</LI>

<UL>
<LI>
<B><TT><I>MIMECharsetFrom</I> </TT></B>is the 1st entry of the <B>CONVERT_FROM</B>
CharSetID you can find in csname2id_tbl of file /lib/libi18n/csnametb.c.
Notice you have to match the case, do not change from upper case to lower
case or vis versa.</LI>

<LI>
<B><TT><I>MIMECharsetTo</I> </TT></B>is the the 1st entry of the <B>CONVERT_TO</B>
CharSetID you can find in csname2id_tbl of file /lib/libi18n/csnametb.c.
Notice you have to match the case, do not change from upper case to lower
case or vis versa.</LI>
</UL>

<LI>
The <B><I><FONT COLOR="#FF0000">red area</FONT></I></B> are the mapping
table for code point 0x80 to 0xFF. Please notice:</LI>

<UL>
<LI>
You have to put two byte togeter with a "0x" in front and "," after that.</LI>

<LI>
You have to put the odd byte before the even byte (0x8180 instead of 0x8081)</LI>
</UL>
</UL>

<H4>
3.<A NAME="winunicodetable"></A>Add Unicode Conversion Tables</H4>
You should add Unicode conversion table for the new CharSetID you add.
The conversion tables for many charset is already generated into directory
<TT>lib/libi18n/unicode/ufrmtbl</TT> and <TT>lib/libi18n/unicode/utotbl</TT>
. In most of the case you simply need to include them into the resource
file. In case if the charset you add do not have a conversion table
in that two directory and you need to generate one. Look at the tools in
<TT>lib/libi18n/unicode/tbltool</TT> directory. Those tool expect the input
file format as those table could be found on unicode ftp site (<A HREF="ftp://ftp.unicode.org/Public/MAPPINGS/">ftp://ftp.unicode.org/Public/MAPPINGS/</A>).
<H4>
Procedure:</H4>
A. Open file <TT>lib/libi18n/unicode/unitable.rc </TT>and add lines

<PRE>
    <B><I>XXX.UF</I></B> RCDATA
    BEGIN
    #include "ufrmtbl\\<B><I>xxx.uf</I></B>"
    END
    <B><I>XXX.UT</I></B> RCDATA
    BEGIN
    #include "utotbl\\<B><I>xxx.ut</I></B>"
    END
</PRE>

where
<UL>
<LI>
<B><I><TT>XXX.UF</TT></I></B> and <B><I><TT>XXX.UT</TT></I></B> are the
RESOURCE ID we defined here. It should be put into <TT>lib/libi18n/unicode/unitbl.c</TT>
file in the next step.</LI>

<LI>
<B><I><TT>xxx.uf</TT></I></B> and <B><I><TT>xxx.ut</TT></I></B> is the
unicode conversion table file which could be found in <TT>lib/libi18n/unicode/ufrmtbl</TT>
and <TT>lib/libi18n/unicode/utotbl</TT> directory.</LI>
</UL>
B. Open file <TT>lib/libi18n/unicode/unitbl.c </TT>and put line
<PRE>
    {<B><I>CS_XXX</I></B>, {"<B><I>XXX.UF</I></B>", 0, NULL}, {"<B><I>XXX.UT</I></B>", 0, NULL}},
</PRE>

to the table <B>utablenametbl</B> before the last entry
<PRE>
    {CS_DEFAULT, {"", 0, NULL}, {"", 0, NULL}}
</PRE>

where
<UL>
<LI>
<B><TT><I>CS_XXX</I> </TT></B>is the CharSetID we try to support Unicode
conversion and</LI>

<LI>
<B><TT><I>XXX.UF</I> </TT></B>and<B><TT> <I>XXX.UT</I> </TT></B>are the
RESOURCE ID we defined in file <TT>lib/libi18n/unicode/unitable.rc</TT>.
Please notice that since a limitation of 16-bit window, you must put all
upper case for RESOURCE ID in this C file, even you may define it as lower
case in the file <TT>lib/libi18n/unicode/unitable.rc.</TT></LI>
</UL>

<H4>
4.<A NAME="winencodingmenu"></A>Add menu items to "View:Encoding"
menu</H4>
If you want to add additional menu items to the "View:Encoding" menu, you
need to do this step.
<H4>
Procedure:</H4>
A. Open file <TT>cmd/winfe/genfram2.cpp</TT>, locate for funciton nIDToCsid()
and add entry to the end of the talbe nid_to_csid, put down the CharSetID
you want it appeared on the "View:Encoding" menu. The position of CharSetID
do not affect the position of the "View:Encoding" menu. It simply decide
what is the nID for that CharSetID <NOBR>(nID = index + ID_OPTIONS_ENCODING_1)</NOBR>.
You need to use that id in file<TT> cmd/winfe/res/mozilla.rc2 </TT>and<TT>
cmd/winfe/res/editor.rc2.</TT> We currently reserved <NOBR>ID_OPTIONS_ENCODING_1
to ID_OPTIONS_ENCODING_70 for this purpose</NOBR>

<P>B.1 Open file <TT>cmd/winfe/res/mozilla.rc2</TT> , locate <B><U>POPUP
"&amp;Encoding"</U> </B>, you will find 8 of them (with two comment out):
<UL>
<LI>
<B>One in IDR_SRVR_INPLACE MENU: </B><I><U>[No idea when this will show
up. It looks like the same as the one in IDM_MAINFRAMEVIEWMENU MENU. Need
to double check with other engineer]</U></I></LI>

<LI>
<B>One in IDR_MAINFRAME MENU:</B><I> <U>[Commented out by C++ comment]</U></I></LI>

<LI>
<B>One in IDM_MAINFRAMEVIEWMENU MENU:</B> This is for the "Encoding" Menu
you see in the Navigator window.</LI>

<LI>
<B>One in IDR_SRVR_EMBEDDED MENU: </B><I><U>[No idea when this will show
up. Need to double check with other engineer]</U></I></LI>

<LI>
<B>One in IDR_MESSAGEFRAME MENU:</B> This is for the "Encoding" Menu you
see in the window which you bring up by double clicking a message
header in the "Messanger Mailbox" window.</LI>

<LI>
<B>One in IDR_MAILTHREAD MENU:<I> </I></B><I><U>[Commented out by C commnet
]</U></I></LI>

<LI>
<B>One in IDM_MAILTHREADVIEWMENU MENU:</B> This is for the "Encoding" Menu
you see in the "Messanger Mailbox" window.</LI>

<LI>
<B>One in IDR_COMPOSEPLAIN MENU: </B>This is for the "Encoding" Menu you
see in the mail composition window when the Preference "Normally send HTML
mail" option is off.</LI>
</UL>
B.2 Open file <TT>cmd/winfe/res/editor.rc2</TT> , locate <B><U>POPUP "&amp;Encoding"</U>
</B>, you will find 2 of them:
<UL>
<LI>
<B>One in IDR_COMPOSEFRAME MENU: </B>This is for the "Encoding" Menu you
see in the mail composition window when the Preference "Normally send HTML
mail" option is on.</LI>

<LI>
<B>One in IDR_EDITFRAME MENU: </B>This is for the "Encoding" Menu you see
in the "Page Composer" window.</LI>
</UL>
B.3 For each of the "Encoding" Menu above, add your menu item by adding
a line
<PRE>
    MENUITEM "<B><I>LanguageGroup</I></B> (<B><I>Charset</I></B>)", <B><I>ID_OPTIONS_ENCODING_XX</I></B>
</PRE>
where
<UL>
<LI>
<TT>"<B><I>LanguageGroup</I></B> (<B><I>Charset</I></B>)"</TT> is the human
readable string on the "Encoding" Menu, and</LI>

<LI>
<B><I><TT>ID_OPTIONS_ENCODING_XX</TT></I> </B>is the nID you map in the
file <TT>cmd/winfe/genfram2.cpp</TT> ( <B><TT>ID_OPTIONS_ENCODING_1</TT>
</B>to<B> <TT>ID_OPTIONS_ENCODING_70</TT></B> is already reserved for you).</LI>
</UL>

<H4>
<B><FONT COLOR="#FF0000">To Be Improved:</FONT></B></H4>
<B><FONT COLOR="#FF0000">Currently all the menu are defined in the front
end. We may move this into cross-platform code and make the menu item easily
changable in the future.</FONT></B>
<H4>
5.<A NAME="winfont"></A>Add menu item for "Font" preference "For
the Encoding" menu</H4>
If you add additional font CharSetID, you need to do the following to make
a new menu item appear in the font preference so people can associate fonts
with that font CharSetID.
<H4>
Procedure:</H4>
A. Open file <TT>cmd/winfe/mozilla.rc</TT> , <B>by using DeveloperStudio,
not text editor, </B>and add additional Stirng for the menu items in "For
the Encoding" menu. You should name the RESOURCE ID <B>IDS_LANGUAGE_XX</B>
so we can easily find them later. Close the file, the Developer Studio
should change <TT>cmd/winfe/mozilla.rc</TT> as well as <TT>cmd/winfe/resource.h
.</TT>

<P>B. Open file <TT>cmd/winfe/intlwin.cpp </TT>and

<P>B.1 Locate lang_table and add new lines
<PRE>
    <B><I>IDS_LANGUAGE_XX</I></B>, <B><I>CS_XXX</I></B>, <B><I>CS_XXX</I></B>, <B><I>CS_YYY</I></B>, 0,
</PRE>
<UL>
<LI>
the 1st item <B>IDS_LANGUAGE_XX </B>is the RESOURCE ID you add to <TT>cmd/winfe/mozilla.rc</TT>
(which get add to <TT>cmd/winfe/resource.h</TT> by Developer Studio automatically)</LI>

<LI>
the 2nd and 3rd item <B>CS_XXX </B>is the CharSetID which will be used
as the Font CharSetID and one of the document CharSetID this Font CharSetID
support.</LI>

<LI>
the 4th item is another document CharSetID you want it to convert to this
Font CharSetID. If there are no other document CharSetID convert to this
Font CharSetID, don't put it in here.</LI>
</UL>
B.2 Locate table fontchar_tbl and add new lines before line
<PRE>
    <B><I>CS_XXX</I></B>, <B>"<I>PropoFont</I>"</B>, 12, <B>"<I>FixedFonte</I>"</B>, 10, <B><I>CHARSET</I></B>, <B><I>CHARSET</I></B>,
</PRE>
where
<UL>
<LI>
the 1st item <B><I>CS_XXX</I> </B>is the Font CharSetID as list in the
previouse step.</LI>

<LI>
the 2nd item <B>"<I><TT><NOBR>PropoFont</NOBR></TT></I>" </B>is the default
font name for Propotional font</LI>

<LI>
the 3rd item12<B> </B>is the default font size for Propotional font</LI>

<LI>
the 4th item <B>"<I><TT><NOBR>FixedFonte</NOBR></TT></I>" </B>is the default
font name for Fixed font</LI>

<LI>
the 5th item10 is the default font size for Fixed font</LI>

<LI>
the 6th and 7th item <B><I><TT><NOBR>CHARSET</NOBR></TT></I> </B>are the
Window CHARSET value for the font, where</LI>
</UL>

<UL>
<UL>
<TABLE BORDER WIDTH="80%" >
<TR>
<TD>Value</TD>

<TD>For</TD>

<TD>Comment</TD>
</TR>

<TR>
<TD>ANSI_CHARSET</TD>

<TD>Western European languages</TD>

<TD></TD>
</TR>

<TR>
<TD>SHIFTJIS_CHARSET</TD>

<TD>Japanese</TD>

<TD></TD>
</TR>

<TR>
<TD>CHINESEBIG5_CHARSET</TD>

<TD>Traditional Chinese</TD>

<TD></TD>
</TR>

<TR>
<TD>HANGEUL_CHARSET</TD>

<TD>Korean</TD>

<TD></TD>
</TR>

<TR>
<TD>DEFAULT_CHARSET</TD>

<TD>UCS2</TD>

<TD></TD>
</TR>

<TR>
<TD>134</TD>

<TD>Simplified Chiense</TD>

<TD>Same as GB2312_CHARSET. However, GB2312_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using GB2312_CHARSET instead of 134
will break 16-bits window build.</TD>
</TR>

<TR>
<TD>177</TD>

<TD>Hebrew</TD>

<TD>Same as HEBREW_CHARSET. However, HEBREW_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using HEBREW_CHARSET instead of 177
will break 16-bits window build.</TD>
</TR>

<TR>
<TD>178</TD>

<TD>Arabic</TD>

<TD>Same as ARABIC_CHARSET. However, ARABIC_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using ARABIC_CHARSET instead of 178
will break 16-bits window build.</TD>
</TR>

<TR>
<TD>161</TD>

<TD>Greek</TD>

<TD>Same as GREEK_CHARSET. However, GREEK_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using GREEK_CHARSET instead of 161
will break 16-bits window build.</TD>
</TR>

<TR>
<TD>162</TD>

<TD>Turkish</TD>

<TD>Same as TURKISH_CHARSET. However, TURKISH_CHARSET is not defined in
16-bits version of header file (WINDOWS.H). Using TURKISH_CHARSET instead
of 162 will break 16-bits window build.</TD>
</TR>

<TR>
<TD>163</TD>

<TD>Vietnamese</TD>

<TD>Same as VIETNAMESE_CHARSET. However, VIETNAMESE_CHARSET is not defined
in 16-bits version of header file (WINDOWS.H). Using VIETNAMESE_CHARSET
instead of 163 will break 16-bits window build.</TD>
</TR>

<TR>
<TD>222</TD>

<TD>Thai</TD>

<TD>Same as THAI_CHARSET. However, THAI_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using THAI_CHARSET instead of 222 will
break 16-bits window build.</TD>
</TR>

<TR>
<TD>238</TD>

<TD>East European languages</TD>

<TD>Same as EASTEUROPE_CHARSET. However, EASTEUROPE_CHARSET is not defined
in 16-bits version of header file (WINDOWS.H). Using EASTEUROPE_CHARSET
instead of 238 will break 16-bits window build.</TD>
</TR>

<TR>
<TD>186</TD>

<TD>Baltic languages</TD>

<TD>Same as BALTIC_CHARSET. However, BALTIC_CHARSET is not defined in 16-bits
version of header file (WINDOWS.H). Using BALTIC_CHARSET instead of 186
will break 16-bits window build.</TD>
</TR>
</TABLE>
</UL>
</UL>
C. Open file <TT>cmd/winfe/intlwin.h </TT>. Change the definition of MAXLANGNUM
to match the number of entries you changed in lang_table. (See step B.1)

<P><FONT SIZE=+3>[Note: Need to talk about modules/libpref/src/win/winpref.js]</FONT>
<H2>

<HR WIDTH="100%"></H2>

<H2>
In Macintosh Code</H2>

<H4>
1.<A NAME="macscript"></A>Add Script to CharSetID mapping</H4>
You need to do the following if you add additional font CharSetID. This
have to be done so a Macintosh Script code could be map to the new CharSetID.
You don't need to do this if you only add addition CharSetID for document
CharSetID and use the existing CharSetID as font CharSetID.
<H4>
Procedure:</H4>
Open file <TT>cmd/macfe/utility/uintl.cp </TT>, Look at the function ScriptToEncoding,
uncomment the Script code which you should map to and add a return statement
to return the CharSetID.
<H4>
<B><FONT COLOR="#FF0000">To Be Improved:</FONT></B></H4>
<B><FONT COLOR="#FF0000">The current implementation should be improved
in near future by moving such mapping into resoruce so no C code need to
be changed.</FONT></B>
<H4>
2.<A NAME="macsinglebyte"></A>Add Single Byte Conversion Table</H4>
If the CharSetID you add is a single byte charset and you want to use One2One
conversion procedure to convert between font CharSetID and document CharSetID
on Macintosh, you need to do this step.
<H4>
Procedure:</H4>
A. [Optional] Open file <TT>cmd/macfe/include/resgui.h</TT> , go to the
end, and add a macro define for the conversion table resource id. This
macro value is used in file <TT>lib/libi18n/fe_ccc.c</TT> as described
in section "<FONT COLOR="#CC33CC">XXXX</FONT>", and the resoruce file you
will create in the next step. We suggest you define the resoruce id as
<PRE>
    #define xlat_<B><I>FromCharSetID</I></B>_TO_<B><I>ToCharSetID</I></B> (((<B><I>FromCharSetID</I></B> &amp; 0xff) &lt;&lt; 8 ) | (<B><I>ToCharSetID</I></B> &amp; 0xff))
</PRE>
where
<UL>
<LI>
<B><I><TT>FromCharSetID</TT> </I></B>is the source CharSetID</LI>

<LI>
<B><I><TT>ToCharSetID </TT></I></B>is the target CharSetID</LI>
</UL>
B. Make a new resoruce file xxx.r and put into <TT>cmd/macfe/restext/</TT>
directory. The new file should look like [Look at <TT>cmd/macfe/restext/cp1250.r</TT>
for real example] :
<PRE>
    #include "csid.h"
    #include "resgui.h"
    data 'xlat' ( xlat_<B><I>FromCharSetID</I></B>_TO_<B><I>ToCharSetID</I></B>, "<B><I>Resoruce Name</I></B>",purgeable){
    /*       x0x1 x2x3 x4x5 x6x7 x8x9 xAxB xCxD xExF */<B><I><FONT COLOR="#FF0000">
    /*8x*/ $"C481 82C9 A5D6 DCE1 B9C8 E4E8 C6E6 E98F"
    /*9x*/ $"9FCF EDEF 9495 96F3 98F4 F69B FACC ECFC"
    /*Ax*/ $"86B0 CAA3 A795 B6DF AEA9 99EA A8AD AEAF"
    /*Bx*/ $"B0B1 B2B3 B4B5 B6B7 B3B9 BABC BEC5 E5BF"
    /*Cx*/ $"C0D1 ACC3 F1D2 C6AB BB85 A0F2 D5CD F5CF"
    /*Dx*/ $"9697 9394 9192 F7D7 D8C0 E0D8 8B9B F8DF"
    /*Ex*/ $"E08A 8284 9A8C 9CC1 8D9D CD8E 9EED D3D4"
    /*Fx*/ $"F0D9 DAF9 DBFB F6F7 DDFD FAAF A3BF FEA1"
    </FONT></I></B>};
</PRE>
where
<UL>
<LI>
<TT>xlat_<B><I>FromCharSetID</I></B>_TO_<B><I>ToCharSetID </I></B></TT>is
the resource id you just defined in file <TT>cmd/macfe/include/resgui.h</TT></LI>

<LI>
The <B><I><FONT COLOR="#FF0000">red area</FONT> </I></B>are the mapping
table for code point 0x80 to 0xFF. Please notice that it is not the same
format as the one in the Window section.</LI>
</UL>

<H4>
<B><FONT COLOR="#FF0000">To Be Improved:</FONT></B></H4>
<B><FONT COLOR="#FF0000">We probably should make the definitation of resource
id a Macro in csid.h to remove the requirement of changing resgui.h .</FONT></B>
<H4>
3.<A NAME="macunicode"></A>Add Unicode Conversion Table</H4>
You should add Unicode conversion table for the new CharSetID you add.
The conversion tables for many charset is already generated into directory
<TT>lib/libi18n/unicode/ufrmtbl</TT> and <TT>lib/libi18n/unicode/utotbl</TT>
. In most of the case you simply need to include them into the resource
file. In case if the charset you add do not have a conversion table
in that two directory and you need to generate one. Look at the tools in
<TT>lib/libi18n/unicode/tbltool</TT> directory. Those tool expect the input
file format as those table could be found on unicode ftp site (<A HREF="ftp://ftp.unicode.org/Public/MAPPINGS/">ftp://ftp.unicode.org/Public/MAPPINGS/</A>).
<H4>
Procedure:</H4>
Open file <TT>cmd/macfe/restext/ufrm.r</TT> , and add lines:
<PRE>
    resource 'UFRM' ( <B><I>CharSetID</I></B>, "<B><I>Resoruce Name</I></B>", purgeable) {{
    #include "<B><I>xxx.uf</I></B>"
    }};
    resource 'UTO ' ( <B><I>CharSetID</I></B>, "<B><I>Resoruce Name</I></B>", purgeable) {{
    #include "<B><I>xxx.ut</I></B>"
    }};
</PRE>
where the <B><I><TT>xxx.uf</TT></I></B> and <B><I><TT>xxx.ut</TT></I></B>
is the unicode conversion table file which could be found in <TT>lib/libi18n/unicode/ufrmtbl</TT>
and <TT>lib/libi18n/unicode/utotbl</TT> directory.
<H4>
4.<A NAME="macencodingmenu"></A>Add menu item to "View:Encoding"
menu</H4>
If you want to add additional menu items to the "View:Encoding" menu, you
need to do this step.
<H4>
Procedure:</H4>
A. Open file <TT>cmd/macfe/include/resgui.h</TT> locate the word ENCODING_CEILING,
and addition line before that line:
<PRE>
    #define <B><I>cmd_XXXX</I></B> 14<B><I>nn</I></B>
</PRE>
where
<UL>
<LI>
<B><I><TT>cmd_XXXX</TT></I></B> is a macro value which will be used in</LI>

<LI>
<TT>14<B><I>nn</I></B></TT> is the "Command ID" value you should put into
file <TT>cmd/macfe/rsrc/navigator/MenusRat.cnst</TT> and <TT>cmd/macfe/rsrc/communicator/Menus.cnst
</TT>as described in the next step. We currenly reserved id from 1401 to
1499 for this purpose. You should use a number which does not conflict
with what currently defined in the file <TT>cmd/macfe/include/resgui.</TT></LI>
</UL>
B. Open file <TT>cmd/macfe/restext/macfe.r</TT> and locate "resource 'Csid'",
add entries into this table:
<PRE>
    fontCharSetID, documentCharSetID, cmd_XXX,
</PRE>
where the first field is the font CharSetID, the second field is the document
CharSetID, and the third one is the Command ID you defined in <TT>cmd/macfe/include/resgui.h.</TT>

<P>C. Open file <TT>cmd/macfe/rsrc/navigator/MenusRat.cnst</TT> and <TT>cmd/macfe/rsrc/communicator/Menus.cnst
</TT>by using Metrowerks Constructor. Open "> Common View Encoding" (Res
ID = 8) in the "Menus" section. Add additional menu items into it.
The "Command ID" should be the one you just defined in file <TT>cmd/macfe/include/resgui.h</TT>
.
<H4>
<B><FONT COLOR="#FF0000">To Be Improved:</FONT></B></H4>

<UL>
<LI>
<B><FONT COLOR="#FF0000">Currently Macintosh source use the same encoding
menu resource for different types of window. We may change to use different
menu resource in the future.</FONT></B></LI>

<LI>
<B><FONT COLOR="#FF0000">Currently all the menu are defined in the front
end. We may move this into cross-platform code and make the menu item easily
changable in the future.</FONT></B></LI>
</UL>

<H4>
5.<A NAME="macfont"></A>Add menu item for "Font" Preference "For
the Encoding" menu</H4>
If you add additional font CharSetID, you need to do the following to make
a new menu item appear in the font preference so people can associate fonts
with that font CharSetID.
<H4>
Procedure:</H4>
A. Open file <TT>cmd/macfe/rsrc/communicator/TextTraits.cnst</TT> by using
Metrowerks Constructor. Add two new TextTraits by coping TextTraits
4001 and 4002. Name your TextTraits with the Font CharSetID so we can figure
out what the TextTraits for later on. The content of these two TextTraits
is not important since it will dynamiclly changed in the application initialization
time. You better make the TextTraits id follow the TextTraits currently
defined for the same purpose (from 4001 to 4024).

<P>B. Open file <TT>cmd/macfe/restext/macfe.r</TT> , locate "resource 'Fnec'",
add additional line
<PRE>
   "<B><I>LanguageGroup</I></B>", "<B><I>PropFont</I></B>", "<B><I>FixedFont</I></B>", 12, 10, <B><I>CharSetID</I></B>, <B><I>ScriptCode</I></B>, <B><I>TextTraitsID1</I></B>, <B><I>TextTraitsID2</I></B>;
</PRE>
where
<UL>
<LI>
<NOBR>the 1st field <B><I><TT>LanguageGroup </TT></I></B></NOBR>is the
string which will appeared on the "for the Encoding" menu on the font prefernece,</LI>

<LI>
<NOBR>the 2nd and 3rd fields <B><I><TT>PropFont </TT></I></B></NOBR>and
<B><I><TT><NOBR>FixedFont</NOBR></TT></I></B> are the default propotional
and fixed font name for that encoding before user change them,</LI>

<LI>
the 4th and 5th fields 12 and 10 are the default propotional and fied font
size for that encoding before user change them,</LI>

<LI>
the 6th field <B><I><TT><NOBR>CharSetID</NOBR></TT></I></B> is the font
CharSetID of this menu item,</LI>

<LI>
the 7th field <B><I><TT><NOBR>ScriptCode</NOBR></TT></I></B> is the Macintosh
script code for the CharSetID.</LI>

<LI>
the 8th and 9th fields <B><I><TT><NOBR>TextTraitsID1, TextTraitsID2 </NOBR></TT></I></B>are
the TextTraits ID we defined in file <TT>cmd/macfe/rsrc/communicator/TextTraits.cnst</TT></LI>
</UL>
The order in this resouce will reflect the order in the "for the Encoding"
menu.
<H2>

<HR WIDTH="100%"></H2>

<H2>
In UNIX Code</H2>

<H4>
1.<A NAME="unixfont"></A>Add Font Handling Code</H4>

<H4>
Procedure:</H4>
A. Open file <TT>cmd/xfe/resources</TT>, locate the <B>"This table maps
X11 font charsets to MIME charsets"</B> section, add or change lines
<PRE>
*documentFonts.charset*<B><I>XLDFCharset</I></B>:    MIMECharset</I></B>
</PRE>
where
<UL>
<LI>
<B><I><TT><NOBR>XLDFCharset</NOBR></TT></I></B> is the XLDF Charset name
and</LI>

<LI>
<B><I><TT><NOBR>MIMECharset</NOBR></TT></I></B> is the MIME Charset of
the font we defined in file <TT>lib/libi18n/csnametb.c </TT>.</LI>
</UL>
B. In the same file, locate the <B>"! This table maps MIME charsets to
language groups"</B> section, add lines after it
<PRE>
    *documentFonts.charsetlang*<B><I>MIMECharset</I></B>:    <B><I>LanguageGroup</I></B>
</PRE>
where
<UL>
<LI>
<B><I><TT><NOBR>MIMECharset</NOBR></TT></I></B> is the MIME Charset of
the font we defined in file <TT>lib/libi18n/csnametb.c</TT></LI>

<LI>
<B><I><TT><NOBR>LanguageGroup </NOBR></TT></I></B>is the menu item display
in the fong preference.</LI>
</UL>
C. In the same file, locate the <B>"! Fonts used for printing" </B>section,
<BR><FONT SIZE=+3>[To Be Written]</FONT>

<P>D. In the same file, locate the <B>"! Unicode Pseudo Font"</B> section,
<BR><FONT SIZE=+3>[To Be Written]</FONT>
<BR>
<BR>E. Open file cmd/xfe/fonts.h,
<BR><FONT SIZE=+3>[To Be Written]</FONT>
<BR>
<H4>
2.<A NAME="unixsinglebyte"></A>Add Single Byte Conversion Table</H4>
If the CharSetID you add is a single byte charset and you want to use One2One
conversion procedure to convert between font CharSetID and document CharSetID
on Unix, you need to do this step.
<H4>
Procedure:</H4>
A. Open file <TT>lib/libi18n/sbconvtb.c</TT>, locate the "#ifdef XP_UNIX"
section, add new table as following
<PRE>
    PRIVATE unsigned char <B><I>MIMECharsetFrom_to_MIMECharsetTo</I></B>[] = {
    <B><I><FONT COLOR="#FF0000">/*8x*/  '?', '?', ',', 'f', '?', '?', '?', '?', '^', '?', 'S', '&lt;', '?', '?', '?', '?',
    /*9x*/  '?', '?', '?', '?', '?', '*', '-', '-', '~', '?', 's', '>', '?', '?', '?', 'Y',
    /*Ax*/ 0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
    /*Bx*/ 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBA,0xBB,0xBC,0xBD,0xBE,0xBF,
    /*Cx*/ 0xC0,0xC1,0xC2,0xC3,0xC4,0xC5,0xC6,0xC7,0xC8,0xC9,0xCA,0xCB,0xCC,0xCD,0xCE,0xCF,
    /*Dx*/ 0xD0,0xD1,0xD2,0xD3,0xD4,0xD5,0xD6,0xD7,0xD8,0xD9,0xDA,0xDB,0xDC,0xDD,0xDE,0xDF,
    /*Ex*/ 0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0xE6,0xE7,0xE8,0xE9,0xEA,0xEB,0xEC,0xED,0xEE,0xEF,
    /*Fx*/ 0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,0xF6,0xF7,0xF8,0xF9,0xFA,0xFB,0xFC,0xFD,0xFE,0xFF
    </FONT></I></B>};
    
    PRIVATE char *<B><I>MIMECharsetFrom_to_MIMECharsetTo</I></B>_p = (char*)<B><I>MIMECharsetFrom_to_MIMECharsetTo</I></B>;</FONT></NOBR></TT>
</PRE>
where
<UL>
<LI>
<B><TT><I>MIMECharsetFrom_TO_MIMECharsetTo</I> </TT></B>is the RESOURCE
ID for the table. You should code this RESOURCE ID as <TT><B><I>MIMECharsetFrom</I></B>_TO_<B><I>MIMECharsetTo</I></B></TT><B>
</B>, where</LI>

<UL>
<LI>
<B><TT><I>MIMECharsetFrom</I> </TT></B>is the 1st entry of the <B>CONVERT_FROM</B>
CharSetID you can find in csname2id_tbl of file /lib/libi18n/csnametb.c.
Notice you have to match the case, do not change from upper case to lower
case or vis versa.</LI>

<LI>
<B><TT><I>MIMECharsetTo</I> </TT></B>is the the 1st entry of the <B>CONVERT_TO</B>
CharSetID you can find in csname2id_tbl of file /lib/libi18n/csnametb.c.
Notice you have to match the case, do not change from upper case to lower
case or vis versa.</LI>
</UL>

<LI>
The <B><I><FONT COLOR="#FF0000">red area</FONT></I></B> are the mapping
table for code point 0x80 to 0xFF.</LI>
</UL>
B. In the same file, locate the function INTL_GetSingleByteTable in the
"#ifdef XP_UNIX" section. Add code to return the table you have add the
the previous step:
<PRE>
    ...
    else if ((from_csid == <B><I>CharSetIDFrom</I></B>) &amp;&amp; (to_csid == <B><I>CharSetIDTo</I></B>)) {
        return &amp;<B><I>MIMECharsetFrom_to_MIMECharsetTo</I></B>_p;
    }
</PRE>
where
<UL>
<LI>
<B><I><TT>CharSetIDFrom </TT></I></B>is the CharSetID for <B><I><TT><NOBR>MIMECharsetFrom,</NOBR></TT></I></B></LI>

<LI>
<B><I><TT>CharSetIDTo </TT></I></B>is the CharSetID for <B><I><TT><NOBR>MIMECharsetTo,</NOBR></TT></I></B></LI>

<LI>
<TT><B><I><NOBR>MIMECharsetFrom_to_MIMECharsetTo</NOBR></I></B>_p </TT>is
the array pointer you just defined in the previouse step.</LI>
</UL>

<H4>
3.<A NAME="unixunicode"></A>Add Unicode Conversion Table</H4>
You should add Unicode conversion table for the new CharSetID you add.
The conversion tables for many charset is already generated into directory
<TT>lib/libi18n/unicode/ufrmtbl</TT> and <TT>lib/libi18n/unicode/utotbl</TT>
. In most of the case you simply need to include them into the resource
file. In case if the charset you add do not have a conversion table
in that two directory and you need to generate one. Look at the tools in
<TT>lib/libi18n/unicode/tbltool</TT> directory. Those tool expect the input
file format as those table could be found on unicode ftp site (<A HREF="ftp://ftp.unicode.org/Public/MAPPINGS/">ftp://ftp.unicode.org/Public/MAPPINGS/</A>).
<H4>
Procedure:</H4>
A. Open file <TT>lib/libi18n/ucs2.c </TT>and locate the "#ifdef XP_UNIX"
section, add lines
<PRE>
    PRIVATE uint16 <B><I>XX</I></B>FromTbl[] = {
    #include "<B><I>xx.uf</I></B>"
    };
    PRIVATE uint16 <B><I>XX</I></B>ToTbl[] = {
    #include "<B><I>xx.ut</I></B>"
    };
</PRE>
where
<UL>
<LI>
<TT><B><I>XX</I></B>FromTbl</TT> and <TT><B><I>XX</I></B>ToTbl</TT>are
the table for the Unicode conversion table.</LI>

<LI>
<B><I><TT>xxx.uf</TT></I></B> and <B><I><TT>xxx.ut</TT></I></B> is the
unicode conversion table file which could be found in <TT>lib/libi18n/unicode/ufrmtbl</TT>
and <TT>lib/libi18n/unicode/utotbl</TT> directory.</LI>
</UL>
B. In the same file, locate "LoadToUCS2Table" function in the "#ifdef XP_UNIX"
section, add code into that function to return <TT><B><I>XX</I></B>FromTbl.</TT>

<P>C. In the same file, locate "LoadFromUCS2Table" function in the "#ifdef
XP_UNIX" section, add code into that function to return <TT><B><I>XX</I></B>ToTbl.</TT>
<H4>
4.<A NAME="unixencoding"></A>Add menu item to "View:Encoding" menu</H4>
If you want to add additional menu items to the "View:Encoding" menu, you
need to do this step.
<H4>
Procedure:</H4>
A. Open file <TT>cmd/xfe/resources</TT>, locate "! View/Encoding Submenu"
and add line into that section:
<PRE>
    *<B><I>languageGroup</I></B>EncCmdString: <B><I>LanguageGroup</I></B> (<B><I>Charset</I></B>)
</PRE>
where
<UL>
<LI>
<TT><B><I>languageGroup</I></B>EncCmdString<B><I> </I></B></TT>is the resource
ID for the menu item. It should be defined as <TT><B><I>languageGroup</I></B>EncCmdString</TT>,
where <B><I><TT>languageGroup</TT></I></B> is the name of the langauge
group. It will be referred in the file <TT>cmd/xfe/src/HTMLView.cpp</TT>
later. See the following steps for details.</LI>

<LI>
<TT><NOBR><B><I>LanguageGroup</I></B> (<B><I>Charset</I></B>) </NOBR></TT>is
the text of the menu item.</LI>
</UL>
B. Open file <TT>cmd/xfe/src/Frame.cpp</TT>, locate the table "XFE_Frame::encoding_menu_spec"
and add line
<PRE>
    { xfeCmdChangeDocumentEncoding, TOGGLEBUTTON, NULL, "EncodingRadioGroup", False, (void*)<B><I>CharSetID</I></B> },
</PRE>
where <B><I><TT>CharSetID</TT></I></B> is the docuemnt CharSetID you defined
in file <TT>include/csid.h</TT>.

<P>C. Open file <TT>cmd/xfe/src/HTMLView.cpp</TT> , locate "XFE_HTMLView::commandToString"
, add code like the following :
<PRE>
    else if (IS_CMD(xfeCmdChangeDocumentEncoding))
    {
        char *res = NULL;
        int doc_csid = (int)calldata;
        switch (doc_csid)
        {
            ...
            case <B><I>CharSetID</I></B>:
               res = "<B><I>languageGroup</I></B>EncCmdString";
               break;
            ...
        }
    }
</PRE>
where
<UL>
<LI>
<B><I><TT>CharSetID </TT></I></B>is the document CharSetID you add for
the encoding menu</LI>

<LI>
<TT><B><I>languageGroup</I></B>EncCmdString<B><I> </I></B></TT>is the resource
ID you defined in file <TT>cmd/xfe/resources</TT> as desceibed above.</LI>
</UL>

<H2>

<HR WIDTH="100%"></H2>

<H2>
Appendix A: Files You Need To Change:</H2>

<TABLE BORDER COLS=2 WIDTH="100%" >
<TR>
<TD WIDTH="20%" BGCOLOR="#66FFFF">Cross-Platform</TD>

<TD>include/csid.h
<BR>lib/libi18n/csnametb.c
<BR>lib/libi18n/csstrlen.c
<BR>lib/libi18n/dblower.c
<BR>lib/libi18n/kinsokuf.c
<BR>lib/libi18n/kinsokud.c
<BR>lib/libi18n/sbconvtb.c
<BR>lib/libi18n/sblower.c
<BR>lib/libi18n/ucs2.c
<BR>lib/libparse/pa_amp.c</TD>
</TR>

<TR>
<TD WIDTH="20%" BGCOLOR="#66FFFF">Window</TD>

<TD>cmd/winfe/res/convtbls.rc
<BR>lib/libi18n/unicode/unitbl.c
<BR>lib/libi18n/unicode/unitable.rc
<BR>cmd/winfe/genfram2.cpp
<BR>cmd/winfe/res/editor.rc2
<BR>cmd/winfe/res/mozilla.rc2
<BR>cmd/winfe/intlwin.cpp
<BR>cmd/winfe/intlwin.h
<BR>cmd/winfe/mozilla.rc
<BR>modules/libpref/src/win/winpref.js</TD>
</TR>

<TR>
<TD WIDTH="20%" BGCOLOR="#66FFFF">Macintosh</TD>

<TD>cmd/macfe/utility/uintl.cp
<BR>cmd/macfe/include/resgui.h
<BR>cmd/macfe/restext/ufrm.r
<BR>cmd/macfe/restext/macfe.r
<BR>cmd/macfe/rsrc/navigator/MenusRat.cnst
<BR>cmd/macfe/rsrc/communicator/Menus.cnst
<BR>cmd/macfe/rsrc/communicator/TextTraits.cnst</TD>
</TR>

<TR>
<TD WIDTH="20%" BGCOLOR="#66FFFF">UNIX</TD>

<TD>cmd/xfe/src/Frame.cpp
<BR>cmd/xfe/src/HTMLView.cpp
<BR>cmd/xfe/resources
<BR>cmd/xfe/fonts.c
<BR>lib/libi18n/ucs2.c</TD>
</TR>
</TABLE>

<CENTER>
<HR></CENTER>

<CENTER>Copyright &copy; 1998 <A HREF="http://home.netscape.com/misc/contact_info.html">Netscape
Communications Corporation</A></CENTER>

<HR>



<hr class="hide">
</div>
</div>
<div id="footer">
<ul>
<li><a href="../../../sitemap.html">Site Map</a></li>
<li><a href="../../../security/">Security Updates</a></li>
<li><a href="../../../contact/">Contact Us</a></li>
<li><a href="../../../foundation/donate.html">Donate</a></li>
</ul>
<p class="copyright">
Portions of this content are &copy; 1998&#8211;2009 by individual mozilla.org
contributors; content available under a Creative Commons license | <a
href="http://www.mozilla.org/foundation/licensing/website-content.html">Details</a>.</p>
<p>
<span>Last modified April 30,  1998</span>
<span><a href="http://bonsai-www.mozilla.org/cvslog.cgi?file=mozilla-org/html/docs/refList/i18n/addcharset.html&amp;rev=&amp;root=/www/">Document History</a></span>
</p>
</div>
</div>
</body>
</html>
